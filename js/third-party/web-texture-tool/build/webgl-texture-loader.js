var k={"image/jpeg":"rgb8unorm","image/png":"rgba8unorm","image/apng":"rgba8unorm","image/gif":"rgba8unorm","image/bmp":"rgb8unorm","image/webp":"rgba8unorm","image/x-icon":"rgba8unorm","image/svg+xml":"rgba8unorm"},v=typeof createImageBitmap!="undefined",T=class{constructor(){}static supportedMIMETypes(){return Object.keys(k)}async fromUrl(e,t,r){let s=k[r.mimeType];if(e.supportedFormatList.indexOf(s)==-1&&(s="rgba8unorm"),v){let o=await fetch(t),n=await createImageBitmap(await o.blob());return e.fromImageBitmap(n,s,r.mipmaps)}else return new Promise((o,n)=>{let c=new Image;c.addEventListener("load",()=>{o(e.textureFromImageElement(c,s,r.mipmaps))}),c.addEventListener("error",function(l){n(l)}),c.src=t})}async fromBlob(e,t,r){let s=k[t.type];if(e.supportedFormatList.indexOf(s)==-1&&(s="rgba8unorm"),v){let o=await createImageBitmap(t);return e.fromImageBitmap(o,s,r.mipmaps)}else return new Promise((o,n)=>{let c=new Image;c.addEventListener("load",()=>{o(e.fromImageElement(c,s,r.mipmaps))}),c.addEventListener("error",function(h){n(h)});let l=window.URL.createObjectURL(t);c.src=l})}async fromBuffer(e,t,r){let s=new Blob(t,{type:r.mimeType});return this.fromBlob(e,s,r)}destroy(){}};var A=import.meta.url.replace(/[^\/]*$/,""),B=class{constructor(e,t,r,s){this.client=e,this.options=t,this.resolve=r,this.reject=s}},p={},R=1;function D(i){let e=p[i.data.id];if(!e){i.data.error&&console.error(`Texture load failed: ${i.data.error}`),console.error(`Invalid pending texture ID: ${i.data.id}`);return}if(delete p[i.data.id],i.data.error){console.error(`Texture load failed: ${i.data.error}`),e.reject(`${i.data.error}`);return}let t=e.client.fromTextureData(i.data,e.options.mipmaps);e.resolve(t)}var b=class{constructor(e){let t=`${A}${e}`;this.worker=new Worker(t),this.worker.onmessage=D}async fromUrl(e,t,r){let s=R++;return this.worker.postMessage({id:s,url:t,supportedFormats:e.supportedFormats(),mipmaps:r.mipmaps,extension:r.extension}),new Promise((o,n)=>{p[s]=new B(e,r,o,n)})}async fromBlob(e,t,r){let s=await t.arrayBuffer();return this.fromBuffer(e,s,r)}async fromBuffer(e,t,r){let s=R++;return this.worker.postMessage({id:s,buffer:t,supportedFormats:e.supportedFormats(),mipmaps:r.mipmaps,extension:r.extension}),new Promise((o,n)=>{p[s]=new B(e,r,o,n)})}destroy(){if(this.worker){this.worker.terminate();let e=new Error("Texture loader was destroyed.");for(let t of p)t.reject(e)}}};var m=WebGLRenderingContext,M={rgb8unorm:{canGenerateMipmaps:!0,gl:{format:m.RGB,type:m.UNSIGNED_BYTE,sizedFormat:32849}},rgba8unorm:{canGenerateMipmaps:!0,gl:{format:m.RGBA,type:m.UNSIGNED_BYTE,sizedFormat:32856}},"rgb8unorm-srgb":{canGenerateMipmaps:!0,gl:{format:m.RGB,type:m.UNSIGNED_BYTE,sizedFormat:35904}},"rgba8unorm-srgb":{canGenerateMipmaps:!0,gl:{format:m.RGBA,type:m.UNSIGNED_BYTE,sizedFormat:35907}},rgb565unorm:{canGenerateMipmaps:!0,gl:{format:m.RGB,type:m.UNSIGNED_SHORT_5_6_5,sizedFormat:m.RGB565}},rgba4unorm:{canGenerateMipmaps:!0,gl:{format:m.RGBA,type:m.UNSIGNED_SHORT_4_4_4_4,sizedFormat:m.RGBA4}},rgba5551unorm:{canGenerateMipmaps:!0,gl:{format:m.RGBA,type:m.UNSIGNED_SHORT_5_5_5_1,sizedFormat:m.RGB5_A1}},bgra8unorm:{canGenerateMipmaps:!0},"bgra8unorm-srgb":{canGenerateMipmaps:!0},"bc1-rgb-unorm":{gl:{texStorage:!0,sizedFormat:33776},compressed:{blockBytes:8,blockWidth:4,blockHeight:4}},"bc2-rgba-unorm":{gl:{texStorage:!0,sizedFormat:33778},compressed:{blockBytes:16,blockWidth:4,blockHeight:4}},"bc3-rgba-unorm":{gl:{texStorage:!1,sizedFormat:33779},compressed:{blockBytes:16,blockWidth:4,blockHeight:4}},"bc7-rgba-unorm":{gl:{texStorage:!0,sizedFormat:36492},compressed:{blockBytes:16,blockWidth:4,blockHeight:4}},"etc1-rgb-unorm":{gl:{texStorage:!1,sizedFormat:36196},compressed:{blockBytes:8,blockWidth:4,blockHeight:4}},"etc2-rgba8unorm":{gl:{texStorage:!0,sizedFormat:37496},compressed:{blockBytes:16,blockWidth:4,blockHeight:4}},"astc-4x4-rgba-unorm":{gl:{texStorage:!0,sizedFormat:37808},compressed:{blockBytes:16,blockWidth:4,blockHeight:4}},"pvrtc1-4bpp-rgb-unorm":{gl:{texStorage:!1,sizedFormat:35840},compressed:{blockBytes:8,blockWidth:4,blockHeight:4}},"pvrtc1-4bpp-rgba-unorm":{gl:{texStorage:!1,sizedFormat:35842},compressed:{blockBytes:8,blockWidth:4,blockHeight:4}}};var L=class{constructor(e,t={}){this.texture=e,this.width=t.width||1,this.height=t.height||1,this.depth=t.depth||1,this.mipLevels=t.mipLevels||1,this.format=t.format||"rgba8unorm",this.type=t.type||"2d"}},C=class{constructor(e,t,r,s=null,o={}){this.format=e,this.width=Math.max(1,t),this.height=Math.max(1,r),this.levels=[],s&&this.getLevel(0).setSlice(0,s,o)}getLevel(e,t={}){let r=this.levels[e];return r||(r=new W(this,e,t),this.levels[e]=r),r}},W=class{constructor(e,t,r){this.textureData=e,this.levelIndex=t,this.width=Math.max(1,r.width||this.textureData.width>>t),this.height=Math.max(1,r.height||this.textureData.height>>t),this.slices=[]}setSlice(e,t,r={}){if(this.slices[e]!=null)throw new Error("Cannot define an image slice twice.");let s=r.byteOffset||0,o=r.byteLength||0,n;t instanceof ArrayBuffer?(n=t,o||(o=n.byteLength-s)):(n=t.buffer,o||(o=t.byteLength-s),s+=t.byteOffset),this.slices[e]={buffer:n,byteOffset:s,byteLength:o}}},f=class{constructor(e,t){this.mimeTypes=e,this.callback=t,this.loader=null}getLoader(){return this.loader||(this.loader=this.callback()),this.loader}},U={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",apng:"image/apng",gif:"image/gif",bmp:"image/bmp",webp:"image/webp",ico:"image/x-icon",cur:"image/x-icon",svg:"image/svg+xml",basis:"image/basis",ktx:"image/ktx",ktx2:"image/ktx2",dds:"image/vnd.ms-dds"},j=[new f(T.supportedMIMETypes(),()=>new T),new f(["image/basis"],()=>new b("workers/basis/basis-worker.js")),new f(["image/ktx","image/ktx2"],()=>new b("workers/ktx/ktx-worker.js")),new f(["image/vnd.ms-dds"],()=>new b("workers/dds-worker.js"))],a=Symbol("wtt/WebTextureClient"),x=Symbol("wtt/WebTextureLoaders"),F=document.createElement("a"),H=typeof createImageBitmap!="undefined",w={extension:null,mipmaps:!0};function G(i,e){if(!e)throw new Error("A valid MIME type must be specified.");let t=i[x][e];t||(t=i[x]["*"]);let r=t.getLoader();if(!r)throw new Error(`Failed to get loader for MIME type "${e}"`);return r}var S=class{constructor(e){this[a]=e,this[x]={};for(let t of j)for(let r of t.mimeTypes)this[x][r]=t;this[x]["*"]=j[0]}async fromUrl(e,t){if(!this[a])throw new Error("Cannot create new textures after object has been destroyed.");let r=Object.assign({},w,t);if(F.href=e,!r.mimeType){let o=F.pathname.lastIndexOf("."),n=o>-1?F.pathname.substring(o+1).toLowerCase():"*";r.mimeType=U[n]}return G(this,r.mimeType).fromUrl(this[a],F.href,r)}async fromBlob(e,t){if(!this[a])throw new Error("Cannot create new textures after object has been destroyed.");let r=Object.assign({},w,t);return G(this,e.type).fromBlob(this[a],e,r)}async fromBuffer(e,t){if(!this[a])throw new Error("Cannot create new textures after object has been destroyed.");let r=Object.assign({},w,t);if(!r.mimeType&&r.filename){let o=r.filename.lastIndexOf("."),n=o>-1?r.filename.substring(o+1).toLowerCase():null;r.mimeType=U[n]}return G(this,r.mimeType).fromBuffer(this[a],e,r)}async fromElement(e,t){if(!this[a])throw new Error("Cannot create new textures after object has been destroyed.");let r=Object.assign({},w,t);if(!H)return this[a].textureFromImageElement(e,"rgba8unorm",r.mipmaps);let s=await createImageBitmap(e);return this[a].fromImageBitmap(s,"rgba8unorm",r.mipmaps)}async fromImageBitmap(e,t){if(!this[a])throw new Error("Cannot create new textures after object has been destroyed.");let r=Object.assign({},w,t);return this[a].fromImageBitmap(e,"rgba8unorm",r.mipmaps)}fromColor(e,t,r,s=1,o="rgba8unorm"){if(!this[a])throw new Error("Cannot create new textures after object has been destroyed.");if(o!="rgba8unorm"&&o!="rgba8unorm-srgb")throw new Error('createTextureFromColor only supports "rgba8unorm" and "rgba8unorm-srgb" formats');let n=new Uint8Array([e*255,t*255,r*255,s*255]);return this[a].fromTextureData(new C(o,1,1,n),!1)}set allowCompressedFormats(e){this[a].allowCompressedFormats=!!e}get allowCompressedFormats(){return this[a].allowCompressedFormats}destroy(){this[a]&&(this[a].destroy(),this[a]=null)}};var _=WebGLRenderingContext;function I(i){return(i&i-1)==0}function O(i,e){return Math.floor(Math.log2(Math.max(i,e)))+1}function N(i){let e=M[i];if(!e||!e.gl)throw new Error(`No matching WebGL format for "${i}"`);return e}function X(i){switch(i){case"cube":return _.TEXTURE_CUBE_MAP;case"2d":default:return _.TEXTURE_2D}}var z=class extends S{constructor(e,t){super(new P(e),t)}},P=class{constructor(e){this.gl=e,this.isWebGL2=this.gl instanceof WebGL2RenderingContext,this.allowCompressedFormats=!0,this.extensions={astc:e.getExtension("WEBGL_compressed_texture_astc"),bptc:e.getExtension("EXT_texture_compression_bptc"),etc1:e.getExtension("WEBGL_compressed_texture_etc1"),etc2:e.getExtension("WEBGL_compressed_texture_etc"),pvrtc:e.getExtension("WEBGL_compressed_texture_pvrtc"),s3tc:e.getExtension("WEBGL_compressed_texture_s3tc")},this.uncompressedFormatList=["rgb8unorm","rgba8unorm","rgb565unorm","rgba4unorm"],this.supportedFormatList=["rgb8unorm","rgba8unorm","rgb565unorm","rgba4unorm"],this.isWebGL2?(this.uncompressedFormatList.push("rgb8unorm-srgb","rgba8unorm-srgb"),this.supportedFormatList.push("rgb8unorm-srgb","rgba8unorm-srgb")):(this.extensions.srgb=e.getExtension("EXT_sRGB"),this.extensions.srgb&&(this.uncompressedFormatList.push("rgb8unorm-srgb","rgba8unorm-srgb"),this.supportedFormatList.push("rgb8unorm-srgb","rgba8unorm-srgb"))),this.extensions.astc&&this.supportedFormatList.push("astc-4x4-rgba-unorm"),this.extensions.bptc&&this.supportedFormatList.push("bc7-rgba-unorm"),this.extensions.etc1&&this.supportedFormatList.push("etc1-rgb-unorm"),this.extensions.etc2&&this.supportedFormatList.push("etc2-rgba8unorm"),this.extensions.pvrtc&&this.supportedFormatList.push("pvrtc1-4bpp-rgb-unorm","pvrtc1-4bpp-rgba-unorm"),this.extensions.s3tc&&this.supportedFormatList.push("bc1-rgb-unorm","bc2-rgba-unorm","bc3-rgba-unorm")}supportedFormats(){return this.allowCompressedFormats?this.supportedFormatList:this.uncompressedFormatList}fromImageBitmap(e,t,r){let s=this.gl;if(!s)throw new Error("Cannot create new textures after object has been destroyed.");!this.isWebGL2&&r&&(r=I(e.width)&&I(e.height));let o=r?O(e.width,e.height):1,n=N(t);if(n.compressed)throw new Error(`Cannot create texture from image with compressed format "${t}"`);let c=s.createTexture();return s.bindTexture(s.TEXTURE_2D,c),this.isWebGL2?(s.texStorage2D(s.TEXTURE_2D,o,n.gl.sizedFormat,e.width,e.height),s.texSubImage2D(s.TEXTURE_2D,0,0,0,n.gl.format,n.gl.type,e)):s.texImage2D(s.TEXTURE_2D,0,n.gl.format,n.gl.format,n.gl.type,e),o>1&&s.generateMipmap(s.TEXTURE_2D),new L(c,{width:e.width,height:e.height,mipLevels:o,format:t})}fromImageElement(e,t,r){return this.textureFromImageBitmap(e,t,r)}fromTextureData(e,t){let r=this.gl;if(!r)throw new Error("Cannot create new textures after object has been destroyed.");let s=N(e.format);s.compressed&&(t=!1),!this.isWebGL2&&t&&(t=I(e.width)&&I(e.height));let o=e.levels.length>1?e.levels.length:t?O(e.width,e.height):1,n=X(e.type),c=r.createTexture();r.bindTexture(n,c);let l=this.isWebGL2&&(!s.compressed||s.gl.texStorage);l&&r.texStorage2D(n,o,s.gl.sizedFormat,e.width,e.height);for(let h=0;h<e.levels.length;++h){let g=e.levels[h];for(let E=0;E<g.slices.length;++E){let u=g.slices[E],y=n==_.TEXTURE_CUBE_MAP?_.TEXTURE_CUBE_MAP_POSITIVE_X+E:n,d;switch(e.format){case"rgb565unorm":case"rgba4unorm":case"rgba5551unorm":d=new Uint16Array(u.buffer,u.byteOffset,u.byteLength/2);break;default:d=new Uint8Array(u.buffer,u.byteOffset,u.byteLength);break}s.compressed?l?r.compressedTexSubImage2D(y,h,0,0,g.width,g.height,s.gl.sizedFormat,d):r.compressedTexImage2D(y,h,s.gl.sizedFormat,g.width,g.height,0,d):l?r.texSubImage2D(y,h,0,0,g.width,g.height,s.gl.format,s.gl.type,d):r.texImage2D(y,h,s.gl.sizedFormat,g.width,g.height,0,s.gl.format,s.gl.type,d)}}return t&&e.levels.length==1&&r.generateMipmap(n),new L(c,{width:e.width,height:e.height,depth:e.depth,mipLevels:o,format:e.format,type:e.type})}destroy(){this.gl=null}};export{z as WebGLTextureLoader};
//# sourceMappingURL=webgl-texture-loader.js.map
